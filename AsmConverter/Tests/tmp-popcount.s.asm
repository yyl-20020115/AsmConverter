[Bits 64]
	align 32, db 0x90
	global __gmpn_popcount
	
	;.def	__gmpn_popcount
	;.scl	2
	;.type	32
	;.endef
__gmpn_popcount:

	push	rdi
	push	rsi
	mov	rdi, rcx
	mov	rsi, rdx


	mov	r8d, esi
	and	r8d, 7

		.byte	0xf3,0x48,0x0f,0xb8,0x07	
	xor	ecx, ecx

	lea	r9, [rip + Ltab]

	movsl	r8, [r9 + r8 * 4]
	add	r8, r9
	jmp	*%r8


L3:
		.byte	0xf3,0x4c,0x0f,0xb8,0x57,0x08
		.byte	0xf3,0x4c,0x0f,0xb8,0x5f,0x10	
	add	rdi, 24
	sub	rsi, 8
	jg	Le34
	add	rax, r10
	add	rax, r11
Ls1:
	pop	rsi
	pop	rdi
	ret

L1:
	sub	rsi, 8
	jle	Ls1
		.byte	0xf3,0x4c,0x0f,0xb8,0x47,0x08	
		.byte	0xf3,0x4c,0x0f,0xb8,0x4f,0x10	
	add	rdi, 8
	jmp	Le12

L7:
		.byte	0xf3,0x4c,0x0f,0xb8,0x57,0x08
		.byte	0xf3,0x4c,0x0f,0xb8,0x5f,0x10	
	add	rdi, -8
	jmp	Le07

L0:
		.byte	0xf3,0x48,0x0f,0xb8,0x4f,0x08
		.byte	0xf3,0x4c,0x0f,0xb8,0x57,0x10	
		.byte	0xf3,0x4c,0x0f,0xb8,0x5f,0x18	
	jmp	Le07

L4:
		.byte	0xf3,0x48,0x0f,0xb8,0x4f,0x08
		.byte	0xf3,0x4c,0x0f,0xb8,0x57,0x10	
		.byte	0xf3,0x4c,0x0f,0xb8,0x5f,0x18	
	add	rdi, 32
	sub	rsi, 8
	jle	Lx4

	align 16, db 0x90
Ltop:
Le34:
		.byte	0xf3,0x4c,0x0f,0xb8,0x07
		.byte	0xf3,0x4c,0x0f,0xb8,0x4f,0x08	
	add	rcx, r10
	add	rax, r11
Le12:
		.byte	0xf3,0x4c,0x0f,0xb8,0x57,0x10
		.byte	0xf3,0x4c,0x0f,0xb8,0x5f,0x18	
	add	rcx, r8
	add	rax, r9
Le07:
		.byte	0xf3,0x4c,0x0f,0xb8,0x47,0x20
		.byte	0xf3,0x4c,0x0f,0xb8,0x4f,0x28	
	add	rcx, r10
	add	rax, r11
Le56:
		.byte	0xf3,0x4c,0x0f,0xb8,0x57,0x30
		.byte	0xf3,0x4c,0x0f,0xb8,0x5f,0x38	
	add	rdi, 64
	add	rcx, r8
	add	rax, r9
	sub	rsi, 8
	jg	Ltop

Lx4:
	add	rcx, r10
	add	rax, r11
Lx2:
	add	rax, rcx

	pop	rsi
	pop	rdi
	ret

L2:
		.byte	0xf3,0x48,0x0f,0xb8,0x4f,0x08
	sub	rsi, 8
	jle	Lx2
		.byte	0xf3,0x4c,0x0f,0xb8,0x47,0x10	
		.byte	0xf3,0x4c,0x0f,0xb8,0x4f,0x18	
	add	rdi, 16
	jmp	Le12

L5:
		.byte	0xf3,0x4c,0x0f,0xb8,0x47,0x08
		.byte	0xf3,0x4c,0x0f,0xb8,0x4f,0x10	
	add	rdi, -24
	jmp	Le56

L6:
		.byte	0xf3,0x48,0x0f,0xb8,0x4f,0x08
		.byte	0xf3,0x4c,0x0f,0xb8,0x47,0x10	
		.byte	0xf3,0x4c,0x0f,0xb8,0x4f,0x18	
	add	rdi, -16
	jmp	Le56
	
				.section .rdata,"dr"
	align 8, db 0x90
Ltab:
		.long	L0-Ltab
		.long	L1-Ltab
		.long	L2-Ltab
		.long	L3-Ltab
		.long	L4-Ltab
		.long	L5-Ltab
		.long	L6-Ltab
		.long	L7-Ltab
