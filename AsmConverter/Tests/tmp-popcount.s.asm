[Bits 64]
	align 32, db 0x90
	global __gmpn_popcount
	
	;.def	__gmpn_popcount
	;.scl	2
	;.type	32
	;.endef
__gmpn_popcount:

	push	rdi
	push	rsi
	mov	rdi, rcx
	mov	rsi, rdx


	mov	r8d, esi
	and	r8d, 7

	db 0xf3,0x48,0x0f,0xb8,0x07
	xor	ecx, ecx
	lea	r9, [rip + Ltab]
	;.byte 0x4c,0x8d,0xd0,0x00,0x00,0x00,0x00

	movsx	r8, dword [r9 + r8 * 4]
	add	r8, r9
	jmp	r8


L3:
	db 0xf3,0x4c,0x0f,0xb8,0x57,0x08
	db 0xf3,0x4c,0x0f,0xb8,0x5f,0x10
	add	rdi, 24
	sub	rsi, 8
	jg	Le34
	add	rax, r10
	add	rax, r11
Ls1:
	pop	rsi
	pop	rdi
	ret

L1:
	sub	rsi, 8
	jle	Ls1
	db 0xf3,0x4c,0x0f,0xb8,0x47,0x08
	db 0xf3,0x4c,0x0f,0xb8,0x4f,0x10
	add	rdi, 8
	jmp	Le12

L7:
	db 0xf3,0x4c,0x0f,0xb8,0x57,0x08
	db 0xf3,0x4c,0x0f,0xb8,0x5f,0x10
	add	rdi, -8
	jmp	Le07

L0:
	db 0xf3,0x48,0x0f,0xb8,0x4f,0x08
	db 0xf3,0x4c,0x0f,0xb8,0x57,0x10
	db 0xf3,0x4c,0x0f,0xb8,0x5f,0x18
	jmp	Le07

L4:
	db 0xf3,0x48,0x0f,0xb8,0x4f,0x08
	db 0xf3,0x4c,0x0f,0xb8,0x57,0x10
	db 0xf3,0x4c,0x0f,0xb8,0x5f,0x18
	add	rdi, 32
	sub	rsi, 8
	jle	Lx4

	align 16, db 0x90
Ltop:
Le34:
	db 0xf3,0x4c,0x0f,0xb8,0x07
	db 0xf3,0x4c,0x0f,0xb8,0x4f,0x08
	add	rcx, r10
	add	rax, r11
Le12:
	db 0xf3,0x4c,0x0f,0xb8,0x57,0x10
	db 0xf3,0x4c,0x0f,0xb8,0x5f,0x18
	add	rcx, r8
	add	rax, r9
Le07:
	db 0xf3,0x4c,0x0f,0xb8,0x47,0x20
	db 0xf3,0x4c,0x0f,0xb8,0x4f,0x28
	add	rcx, r10
	add	rax, r11
Le56:
	db 0xf3,0x4c,0x0f,0xb8,0x57,0x30
	db 0xf3,0x4c,0x0f,0xb8,0x5f,0x38
	add	rdi, 64
	add	rcx, r8
	add	rax, r9
	sub	rsi, 8
	jg	Ltop

Lx4:
	add	rcx, r10
	add	rax, r11
Lx2:
	add	rax, rcx

	pop	rsi
	pop	rdi
	ret

L2:
	db 0xf3,0x48,0x0f,0xb8,0x4f,0x08
	sub	rsi, 8
	jle	Lx2
	db 0xf3,0x4c,0x0f,0xb8,0x47,0x10
	db 0xf3,0x4c,0x0f,0xb8,0x4f,0x18
	add	rdi, 16
	jmp	Le12

L5:
	db 0xf3,0x4c,0x0f,0xb8,0x47,0x08
	db 0xf3,0x4c,0x0f,0xb8,0x4f,0x10
	add	rdi, -24
	jmp	Le56

L6:
	db 0xf3,0x48,0x0f,0xb8,0x4f,0x08
	db 0xf3,0x4c,0x0f,0xb8,0x47,0x10
	db 0xf3,0x4c,0x0f,0xb8,0x4f,0x18
	add	rdi, -16
	jmp	Le56
	
		section .rdata
	align 8, db 0x90
Ltab:
	dd L0-Ltab
	dd L1-Ltab
	dd L2-Ltab
	dd L3-Ltab
	dd L4-Ltab
	dd L5-Ltab
	dd L6-Ltab
	dd L7-Ltab
